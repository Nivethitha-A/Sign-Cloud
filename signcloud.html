<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SignCloud ‚Äî Virtual Classroom (Host-top layout)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#061022; --panel:#0e1624; --muted:#9aa3b2; --accent:#4f8cff; --accent2:#27d6a2; --danger:#ff5d5d;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#041224);color:#eaf2ff}
  header{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;border-bottom:1px solid rgba(255,255,255,.03)}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(135deg,var(--accent),#6ef3ff);font-weight:700}
  .chip{padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,.03);color:var(--muted);font-size:0.9rem}

  /* grid layout */
  .container{display:grid;grid-template-columns:1fr 360px;gap:12px;height:calc(100vh - 64px);padding:12px;}
  .left-col{display:flex;flex-direction:column;gap:12px}
  .right-col{display:flex;flex-direction:column;gap:12px}

  /* host area */
  .host-card{background:var(--panel);border-radius:12px;padding:0;box-shadow:0 24px 80px rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.02);position:relative;overflow:hidden;height:46vh;min-height:360px}
  #hostVideo{width:100%;height:100%;object-fit:cover;background:#000;display:block}
  #gestureCanvas{position:absolute;left:0;top:0;pointer-events:none}
  .translation{position:relative;margin-top:0;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#021226;padding:12px 18px;border-radius:12px;font-weight:800;font-size:20px;box-shadow:0 8px 20px rgba(0,0,0,.45)}
  .translation-meta{color:var(--muted);font-size:12px;margin-top:6px}

  /* dock */
  .dock-wrap{display:flex;justify-content:center}
  .dock{display:flex;gap:18px;align-items:center;background:transparent;padding:12px;border-radius:12px}
  .tool{width:64px;height:64px;border-radius:999px;border:none;background:rgba(255,255,255,.03);display:grid;place-items:center;color:#eaf2ff;font-size:22px;cursor:pointer;transition:transform .14s}
  .tool:hover{transform:translateY(-6px)}
  .tool.active{background:linear-gradient(135deg,var(--accent),#6ef3ff);color:#021226}
  .tool.leave{background:linear-gradient(90deg,var(--danger),#ff8b8b);color:#021226}
  .tool-label{font-size:12px;color:var(--muted);text-align:center;margin-top:6px}
  .tool-col{display:flex;flex-direction:column;align-items:center;gap:6px}

  /* translation panel below dock */
  .translation-panel{display:flex;flex-direction:column;gap:6px;padding:10px;border-radius:10px;background:var(--panel);border:1px solid rgba(255,255,255,.02)}

  /* participants fixed 4 tiles */
  .participants-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .participant-tile{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,.02);display:flex;flex-direction:column;min-height:120px;align-items:center;justify-content:flex-start;position:relative;cursor:pointer}
  .participant-tile video{width:100%;height:100%;object-fit:cover;border-radius:8px;background:#111}
  .participant-avatar{width:100%;height:100px;border-radius:8px;background:#0b1220;display:grid;place-items:center;font-weight:700;color:var(--muted)}
  .participant-meta{width:100%;display:flex;justify-content:space-between;align-items:center;margin-top:8px}
  .small-muted{color:var(--muted);font-size:13px}

  /* right column (chat, others, waiting) */
  .panel{background:var(--panel);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.02);min-height:0;display:flex;flex-direction:column}
  .panel h3{margin:0 0 8px 0}
  .chat-messages{flex:1;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,.01)}
  .chat-input{display:flex;gap:8px;margin-top:8px}
  .chat-input input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.03);background:transparent;color:var(--muted)}
  .btn{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#021226;cursor:pointer}
  .danger{background:var(--danger);color:#210000}
  .list-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,.01);margin-bottom:8px}
  .small-info{font-size:13px;color:var(--muted)}
  .other-list{display:flex;flex-direction:column;gap:8px;max-height:22vh;overflow:auto}

  /* reactions popup */
  .reactions-popup{position:absolute;bottom:108px;left:50%;transform:translateX(-50%);display:none;background:linear-gradient(180deg,#071022,#061221);padding:8px;border-radius:12px;border:1px solid rgba(255,255,255,.03);z-index:60;display:flex;gap:8px}
  .reactions-popup button{padding:8px;border-radius:8px;border:none;background:transparent;color:var(--muted);font-size:20px;cursor:pointer}

  /* reaction overlay bubble */
  .reaction-bubble{position:absolute;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,#fff,#fff);color:#021226;font-weight:700;font-size:20px;box-shadow:0 10px 30px rgba(0,0,0,.5);pointer-events:none;transform:translate(-50%,-50%);z-index:300}

  /* modal */
  .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:grid;place-items:center;z-index:200}
  .modal{background:var(--panel);padding:18px;border-radius:12px;width:420px;border:1px solid rgba(255,255,255,.04)}
  .form-row{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  .form-row input, .form-row select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:var(--muted)}

  @media(max-width:1100px){
    .container{grid-template-columns:1fr 320px}
    .participants-grid{grid-template-columns:repeat(2,1fr)}
  }
  @media(max-width:820px){
    .container{grid-template-columns:1fr}
    .right-col{order:2}
    .left-col{order:1}
    .participants-grid{grid-template-columns:repeat(2,1fr)}
  }
</style>
</head>
<body>
<header>
  <div class="brand"><div class="logo">ü§ü</div><div><div style="font-weight:700">SignCloud Classroom</div><div class="small-muted">Sign language ‚Üí text (MediaPipe Hands)</div></div></div>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="chip" id="roomLabel">room: class-101</div>
    <div class="chip" id="statusLabel">Ready</div>
  </div>
</header>

<div class="container">
  <div class="left-col">
    <!-- Host video -->
    <div class="host-card" id="hostCard">
      <video id="hostVideo" autoplay playsinline muted></video>
      <canvas id="gestureCanvas"></canvas>
    </div>

    <!-- Dock -->
    <div class="dock-wrap" style="position:relative">
      <div class="dock" id="mainDock">
        <div class="tool-col"><button id="muteBtn" class="tool" title="Mute (M)">üé§</button><div class="tool-label">Mute</div></div>
        <div class="tool-col"><button id="camBtn" class="tool active" title="Video (V)">üì∑</button><div class="tool-label">Video</div></div>
        <div class="tool-col"><button id="reactionPickerBtn" class="tool" title="Reactions">üòä</button><div class="tool-label">Reactions</div></div>
        <div class="tool-col"><button id="raiseBtn" class="tool" title="Raise Hand (R)">‚úã</button><div class="tool-label">Raise</div></div>
        <div class="tool-col"><button id="leaveBtn" class="tool leave" title="Leave">‚èπ</button><div class="tool-label">Leave</div></div>
      </div>

      <div class="reactions-popup" id="reactionsPopup">
        <button class="react" data-r="‚ù§Ô∏è">‚ù§Ô∏è</button>
        <button class="react" data-r="üëè">üëè</button>
        <button class="react" data-r="üëç">üëç</button>
        <button class="react" data-r="üòÇ">üòÇ</button>
        <button class="react" data-r="üéâ">üéâ</button>
        <button class="react" data-r="üòç">üòç</button>
        <button class="react" data-r="üìù">üìù</button>
        <button class="react" data-r="‚úã">‚úã</button>
      </div>
    </div>

    <!-- Translation panel (separate below dock) -->
    <div class="translation-panel" id="translationPanel">
      <div class="translation" id="translation">Waiting for gesture...</div>
      <div class="translation-meta" id="translationMeta">‚Äî</div>
    </div>

    <!-- Participants (fixed 4 tiles) -->
    <div class="participants-grid" id="tilesGrid" aria-live="polite">
      <!-- JS will render exactly 4 tiles -->
    </div>
  </div>

  <!-- Right column -->
  <div class="right-col">
    <!-- Chat panel -->
    <div class="panel" style="flex:1;min-height:220px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Chat</h3>
        <div class="small-muted" id="participantsCount">0 participants</div>
      </div>
      <div id="chatMessages" class="chat-messages" role="log" aria-live="polite"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Type a message..." />
        <button id="chatSend" class="btn">Send</button>
      </div>
    </div>

    <!-- Participants list + waiting room -->
    <div class="panel" style="min-height:260px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Participants</h3>
        <div class="small-muted" id="otherCount">0 others</div>
      </div>
      <div style="margin-top:10px">
        <div style="font-weight:700;margin-bottom:8px">Main (4)</div>
        <div id="mainList" class="other-list" style="margin-bottom:6px"></div>

        <div style="font-weight:700;margin-top:8px;margin-bottom:8px">Other Participants</div>
        <div id="otherList" class="other-list"></div>

        <div style="font-weight:700;margin-top:8px;margin-bottom:8px">Waiting Room</div>
        <div id="waitingPane"></div>
      </div>
    </div>
  </div>
</div>

<!-- Join modal -->
<div id="joinModalBackdrop" class="modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Enter details to join</h2>
    <div class="form-row"><label>Name</label><input id="joinName" placeholder="Your name" /></div>
    <div class="form-row"><label>Email (gmail)</label><input id="joinEmail" placeholder="you@gmail.com" /></div>
    <div class="form-row"><label>Role</label><select id="joinRole"><option value="host">Host</option><option value="student">Student</option></select></div>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="joinCancel" class="btn">Cancel</button>
      <button id="joinSubmit" class="btn">Join</button>
    </div>
    <div class="small-muted" style="margin-top:12px">Host must allow camera for gesture detection. Students will wait in the waiting room until admitted.</div>
  </div>
</div>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
/* Final merged SignCloud layout:
   - Host big at top
   - Dock below host
   - Translation panel below dock (HOST only)
   - 4 participant tiles (fixed)
   - Other participants & waiting room in right panel
   - Chat only stores chat messages (no gesture logs)
   - Reactions popup: choose emoji, then click tile (or host) to apply
*/

// ---------- State ----------
let LOCAL = null;
const PARTICIPANTS = {}; // id -> participant
let NEXT_ID = 1;
let localStream = null;
let hands = null;
let cameraMp = null;
let detHistory = [];
const DET_HISTORY_LEN = 6;
let lastPublished = { text:null, ts:0 };
const PUBLISH_COOLDOWN = 1500;

// reaction selection state
let pendingReaction = null;
let pendingReactionTimer = null;

// ---------- Helpers ----------
function uid(){ return 'u' + (NEXT_ID++); }
function now(){ return new Date().toLocaleTimeString(); }
function initials(name){
  if(!name) return 'U';
  return name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
}
function avatarDataUrl(name,size=64){
  const txt = initials(name);
  const bg = '#0b1220';
  const fg = '#9aa3b2';
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><rect rx='12' width='100%' height='100%' fill='${bg}'/><text x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Inter,Arial' font-size='22' fill='${fg}'>${txt}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}

// ---------- DOM refs ----------
const hostVideo = document.getElementById('hostVideo');
const gestureCanvas = document.getElementById('gestureCanvas');
const gctx = gestureCanvas.getContext('2d');
const translationEl = document.getElementById('translation');
const translationMeta = document.getElementById('translationMeta');
const tilesGrid = document.getElementById('tilesGrid');
const mainList = document.getElementById('mainList');
const otherList = document.getElementById('otherList');
const waitingPane = document.getElementById('waitingPane');
const otherCountEl = document.getElementById('otherCount');
const participantsCountEl = document.getElementById('participantsCount');
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');
const chatSend = document.getElementById('chatSend');
const joinModalBackdrop = document.getElementById('joinModalBackdrop');
const joinName = document.getElementById('joinName');
const joinEmail = document.getElementById('joinEmail');
const joinRole = document.getElementById('joinRole');
const joinSubmit = document.getElementById('joinSubmit');
const joinCancel = document.getElementById('joinCancel');
const reactionPickerBtn = document.getElementById('reactionPickerBtn');
const reactionsPopup = document.getElementById('reactionsPopup');
const reactionsButtons = document.querySelectorAll('.react');
const muteBtn = document.getElementById('muteBtn');
const camBtn = document.getElementById('camBtn');
const raiseBtn = document.getElementById('raiseBtn');
const leaveBtn = document.getElementById('leaveBtn');
const hostCard = document.getElementById('hostCard');

// ---------- Participant functions ----------
function addParticipant(name, opts = {}){
  const id = opts.id || uid();
  const p = {
    id,
    name: name || ('Student ' + id),
    email: opts.email || (name ? (name.toLowerCase().replace(/\s+/g,'.') + '@gmail.com') : id + '@gmail.com'),
    avatar: opts.avatar || avatarDataUrl(name || ('S' + id)),
    host: !!opts.host,
    admitted: !!opts.admitted,
    waiting: !!opts.waiting,
    raised: !!opts.raised,
    mic: opts.mic === undefined ? true : !!opts.mic,
    stream: opts.stream || null
  };
  PARTICIPANTS[id] = p;
  renderAll();
  return p;
}
function removeParticipant(id){
  if(!PARTICIPANTS[id]) return;
  if(PARTICIPANTS[id].stream){
    try{ PARTICIPANTS[id].stream.getTracks().forEach(t=>t.stop()); }catch(e){}
  }
  delete PARTICIPANTS[id];
  renderAll();
}
function admit(id){
  if(!PARTICIPANTS[id]) return;
  PARTICIPANTS[id].waiting = false;
  PARTICIPANTS[id].admitted = true;
  appendSystem(`${PARTICIPANTS[id].name} admitted`);
  renderAll();
}
function deny(id){
  if(!PARTICIPANTS[id]) return;
  appendSystem(`${PARTICIPANTS[id].name} denied`);
  delete PARTICIPANTS[id];
  renderAll();
}
window.kick = function(id){ removeParticipant(id); appendSystem('Participant removed'); };

// ---------- Render UI ----------
function renderTiles(){
  tilesGrid.innerHTML = '';
  const admitted = Object.values(PARTICIPANTS).filter(p => p.admitted);
  const primary = admitted.slice(0,4);

  for(let i=0;i<4;i++){
    const p = primary[i];
    const tile = document.createElement('div'); tile.className = 'participant-tile'; tile.dataset.slot = i;
    if(p && p.stream){
      const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject = p.stream;
      v.style.width='100%'; v.style.height='100%'; v.style.objectFit='cover';
      tile.appendChild(v);
    } else if(p){
      const av = document.createElement('div'); av.className='participant-avatar';
      av.innerHTML = `<img src="${p.avatar}" style="width:100%;height:100%;object-fit:cover;border-radius:8px"/>`;
      tile.appendChild(av);
    } else {
      const av = document.createElement('div'); av.className='participant-avatar'; av.textContent = 'Empty';
      tile.appendChild(av);
    }
    const meta = document.createElement('div'); meta.className='participant-meta';
    if(p){
      meta.innerHTML = `<div><div style="font-weight:700">${p.name}${p.host? ' ‚Ä¢ Host':''}</div><div class="small-muted">${p.email}</div></div><div><div class="small-muted">${p.mic ? 'üé§' : 'üîá'}</div></div>`;
    } else {
      meta.innerHTML = `<div class="small-muted">Free slot</div><div></div>`;
    }
    tile.appendChild(meta);

    // clicking a tile applies pending reaction (if any)
    tile.addEventListener('click', ()=> {
      if(pendingReaction){
        spawnReactionOnElement(tile, pendingReaction, LOCAL?LOCAL.name:'You');
        clearPendingReaction();
      }
    });

    tilesGrid.appendChild(tile);
  }

  // mainList summary
  mainList.innerHTML = '';
  primary.forEach(p => {
    if(!p) return;
    const r = document.createElement('div'); r.className='list-row';
    r.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${p.avatar}" style="width:40px;height:40px;border-radius:6px"/><div><div style="font-weight:700">${p.name}${p.host? ' ‚Ä¢ Host':''}</div><div class="small-muted">${p.email}</div></div></div><div class="small-muted">${p.mic? 'üé§':'üîá'}</div>`;
    mainList.appendChild(r);
  });

  // others list
  const others = admitted.slice(4);
  otherList.innerHTML = '';
  others.forEach(p => {
    const row = document.createElement('div'); row.className='list-row';
    row.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><img src="${p.avatar}" style="width:40px;height:40px;border-radius:6px"/><div><div style="font-weight:700">${p.name}</div><div class="small-muted">${p.email}</div></div></div><div><button class="btn" onclick="promoteToMain('${p.id}')">Promote</button></div>`;
    otherList.appendChild(row);
  });

  otherCountEl.textContent = others.length + ' others';
  participantsCountEl.textContent = admitted.length + ' participants';
}

function promoteToMain(id){
  // Place selected participant earlier in the admitted array by toggling a _promote timestamp
  if(!PARTICIPANTS[id]) return;
  PARTICIPANTS[id]._promote = Date.now();
  // We will consider _promote when sorting when rendering tiles (simple approach - rebuild by sorting admitted)
  // For simplicity, we won't actually reorder the object; instead, call renderAll which uses slice(0,4) over admitted sorted by _promote.
  renderAll();
}

function renderWaiting(){
  waitingPane.innerHTML = '';
  const arr = Object.values(PARTICIPANTS).filter(p=>p.waiting);
  arr.forEach(w=>{
    const row = document.createElement('div'); row.className='list-row';
    const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${w.name}</div><div class="small-muted">${w.email}</div>`;
    const right = document.createElement('div');
    const admitBtn = document.createElement('button'); admitBtn.className='btn'; admitBtn.textContent='Admit'; admitBtn.onclick = ()=> admit(w.id);
    const denyBtn = document.createElement('button'); denyBtn.className='btn'; denyBtn.style.marginLeft='8px'; denyBtn.textContent='Deny'; denyBtn.onclick = ()=> deny(w.id);
    right.appendChild(admitBtn); right.appendChild(denyBtn);
    row.appendChild(left); row.appendChild(right);
    waitingPane.appendChild(row);
  });
}

function renderAll(){
  // Ensure admitted order: host first, then by _promote (desc), then by creation (id)
  const admitted = Object.values(PARTICIPANTS).filter(p => p.admitted);
  admitted.sort((a,b) => {
    if(a.host && !b.host) return -1;
    if(b.host && !a.host) return 1;
    if((b._promote||0) !== (a._promote||0)) return (b._promote||0) - (a._promote||0);
    return a.id.localeCompare(b.id);
  });
  // Re-map PARTICIPANTS to a temporary ordered list for rendering
  // Replace the admitted list in the rendering functions by assuming filter above is used
  // For simplicity, we will rely on renderTiles to call admitted sort again.
  renderTiles();
  renderWaiting();
}

// ---------- Chat ----------
function appendChat(author, text){
  const el = document.createElement('div'); el.className='chat-msg';
  el.innerHTML = `<div style="font-weight:700">${author}</div><div>${text}</div><div class="small-muted">${now()}</div>`;
  chatMessages.appendChild(el); chatMessages.scrollTop = chatMessages.scrollHeight;
}
function appendSystem(text){ appendChat('System', text); }
chatSend.addEventListener('click', ()=> {
  const t = chatInput.value.trim(); if(!t) return;
  appendChat(LOCAL ? LOCAL.name : 'You', t); chatInput.value = '';
});

// ---------- Reactions (apply to host or a tile) ----------
function spawnReactionOnElement(el, sym, actorName){
  // position bubble centered in element
  const rect = el.getBoundingClientRect();
  const bubble = document.createElement('div'); bubble.className='reaction-bubble';
  bubble.textContent = sym;
  document.body.appendChild(bubble);
  bubble.style.left = (rect.left + rect.width/2) + 'px';
  bubble.style.top = (rect.top + rect.height*0.2) + 'px';
  setTimeout(()=> bubble.remove(), 1600);
  // also add to chat as feedback (only system style)
  appendSystem(`${actorName || (LOCAL?LOCAL.name:'You')} ${sym}`);
}
function spawnReactionDefault(sym){
  // spawn over host area by default
  spawnReactionOnElement(hostCard, sym, LOCAL?LOCAL.name:'You');
}

// clicking a reaction emoji sets pending state; then clicking a tile applies
reactionPickerBtn.addEventListener('click', ()=> {
  reactionsPopup.style.display = reactionsPopup.style.display === 'flex' ? 'none' : 'flex';
});
reactionsButtons.forEach(b => b.addEventListener('click', ()=> {
  const sym = b.dataset.r;
  pendingReaction = sym;
  reactionsPopup.style.display = 'none';
  // attach a short timer; allow user to click a tile within 3s
  appendSystem(`Selected reaction ${sym} ‚Äî click a tile to apply (defaults to host in 3s)`);
  if(pendingReactionTimer) clearTimeout(pendingReactionTimer);
  pendingReactionTimer = setTimeout(()=> {
    if(pendingReaction){ spawnReactionDefault(pendingReaction); clearPendingReaction(); }
  }, 3000);
}));

function clearPendingReaction(){
  pendingReaction = null;
  if(pendingReactionTimer){ clearTimeout(pendingReactionTimer); pendingReactionTimer = null; }
}

// allow clicking host area to apply pending reaction too
hostCard.addEventListener('click', ()=> {
  if(pendingReaction){ spawnReactionOnElement(hostCard, pendingReaction, LOCAL?LOCAL.name:'You'); clearPendingReaction(); }
});

// ---------- Buttons: mute/cam/raise/leave ----------
let micEnabled=true, camEnabled=true;
muteBtn.addEventListener('click', ()=> {
  if(!localStream){ appendSystem('Join as host to mute/unmute'); return; }
  micEnabled = !micEnabled; localStream.getAudioTracks().forEach(t=>t.enabled = micEnabled);
  muteBtn.classList.toggle('active', !micEnabled);
  muteBtn.textContent = micEnabled ? 'üé§' : 'üîá';
  appendSystem(micEnabled ? 'Microphone on' : 'Microphone muted');
});
camBtn.addEventListener('click', ()=> {
  if(!localStream){ appendSystem('Join as host to toggle camera'); return; }
  camEnabled = !camEnabled; localStream.getVideoTracks().forEach(t=>t.enabled = camEnabled);
  camBtn.classList.toggle('active', camEnabled);
  camBtn.textContent = camEnabled ? 'üì∑' : 'üö´';
  appendSystem(camEnabled ? 'Camera on' : 'Camera off');
  renderAll();
});
raiseBtn.addEventListener('click', ()=> {
  if(!LOCAL){ appendSystem('Join to raise hand'); return; }
  LOCAL.raised = !LOCAL.raised; PARTICIPANTS[LOCAL.id].raised = LOCAL.raised;
  renderAll();
  appendSystem(LOCAL.name + (LOCAL.raised ? ' raised hand' : ' lowered hand'));
});
leaveBtn.addEventListener('click', ()=> {
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = null;
  if(LOCAL) delete PARTICIPANTS[LOCAL.id];
  LOCAL = null; hostVideo.srcObject = null;
  renderAll(); appendSystem('You left the classroom');
  joinModalBackdrop.style.display = 'grid';
});

// ---------- Join modal ----------
joinCancel.addEventListener('click', ()=> joinModalBackdrop.style.display = 'none');
joinSubmit.addEventListener('click', async ()=> {
  const name = (joinName.value || '').trim();
  const email = (joinEmail.value || '').trim();
  const role = joinRole.value;
  if(!name || !email){ alert('Enter name and email'); return; }
  if(role === 'student'){
    addParticipant(name, { email, waiting:true });
    appendSystem(`${name} added to waiting room`);
    joinModalBackdrop.style.display = 'none';
    return;
  }
  // host flow
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{width:1280,height:720}, audio:true });
    localStream = stream;
    hostVideo.srcObject = stream;
    const p = addParticipant(name, { email, host:true, admitted:true, stream });
    LOCAL = p;
    joinModalBackdrop.style.display = 'none';
    appendSystem(`Host ${name} joined and camera started`);
    initMediaPipe();
  }catch(err){
    appendSystem('Camera access error: ' + (err.message || err));
  }
});

// ---------- seed participants (demo) ----------
(function seed(){
  addParticipant('Student A', {admitted:true});
  addParticipant('Student B', {admitted:true});
  addParticipant('Student C', {admitted:true});
  addParticipant('Student D', {admitted:true});
  addParticipant('Other E', {admitted:true});
  addParticipant('Waiting Student', {waiting:true});
})();

// ---------- MediaPipe detection ----------
function resizeCanvas(){
  const r = hostCard.getBoundingClientRect();
  gestureCanvas.width = r.width;
  gestureCanvas.height = r.height;
  gestureCanvas.style.left = r.left + 'px';
  gestureCanvas.style.top = r.top + 'px';
  gestureCanvas.style.width = r.width + 'px';
  gestureCanvas.style.height = r.height + 'px';
}
window.addEventListener('resize', resizeCanvas);

function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function fingerExtended(lm, tipIdx, pipIdx){ return lm[tipIdx].y < lm[pipIdx].y; }
function thumbExtended(lm, handedness){
  if(handedness === 'Left') return lm[4].x > lm[3].x;
  return lm[4].x < lm[3].x;
}
function fingersUp(lm, handedness){
  return [
    thumbExtended(lm,handedness),
    fingerExtended(lm,8,6),
    fingerExtended(lm,12,10),
    fingerExtended(lm,16,14),
    fingerExtended(lm,20,18)
  ];
}

let wristXHistory = [];
function detectWave(lm){
  wristXHistory.push(lm[0].x);
  if(wristXHistory.length > 18) wristXHistory.shift();
  if(wristXHistory.length >= 16){
    const r = Math.max(...wristXHistory) - Math.min(...wristXHistory);
    return r > 0.18;
  }
  return false;
}

let twoDist = [];
function detectZoomTrend(d){
  twoDist.push(d); if(twoDist.length > 12) twoDist.shift();
  if(twoDist.length >= 8){
    const first = twoDist[0], last = twoDist[twoDist.length - 1];
    if(last - first > 0.09) return 'Zoom Out üîç';
    if(first - last > 0.09) return 'Zoom In üîé';
  }
  return null;
}

function detectSingleHand(lm, handedness){
  const up = fingersUp(lm, handedness);
  const [T,I,M,R,P] = up;
  if(dist(lm[4], lm[8]) < 0.05 && !M && !R && !P) return 'Pinch ü§è';
  if(dist(lm[4], lm[8]) < 0.08 && M && R && P) return 'OK üëå';
  if(T && !I && !M && !R && !P){
    if(lm[4].y < lm[2].y) return 'Thumbs Up üëç';
    return 'Thumbs Down üëé';
  }
  if(T && I && !M && !R && P) return 'I Love You ü§ü';
  if(T && !I && !M && !R && P) return 'Call Me ü§ô';
  if(!T && I && !M && !R && !P) {
    if(lm[8].x > 0.8) return 'Point Right üëâ';
    if(lm[8].x < 0.2) return 'Point Left üëà';
    if(lm[8].y < lm[6].y - 0.08) return 'Point Up ‚òùÔ∏è';
    if(lm[8].y > lm[6].y + 0.08) return 'Point Down üëá';
    return 'Point ‚òùÔ∏è';
  }
  if(!T && !I && !M && !R && !P) return 'Fist ‚úä';
  if(!T && I && M && !R && !P) return 'Peace ‚úåÔ∏è';
  if(!T && I && !M && !R && P) return 'Rock ü§ò';
  if(!T && I && M && R && !P) return 'Three 3Ô∏è‚É£';
  if(!T && I && M && R && P) return 'Four 4Ô∏è‚É£';
  if(T && I && M && R && P) return 'Five üñêÔ∏è';
  if(!T && I && !M && !R && !P && Math.abs(lm[8].y - lm[0].y) < 0.07) return 'Shhh ü§´';
  const xs = lm.map(p=>p.x), ys = lm.map(p=>p.y);
  const w = Math.max(...xs) - Math.min(...xs), h = Math.max(...ys) - Math.min(...ys);
  if(w > 0.06 && h > 0.06 && (lm[8].x - lm[4].x) > 0.04 && (lm[8].y - lm[4].y) < 0.12) return 'C Sign (C)';
  if(detectWave(lm)) return 'Wave üëã';
  const spread = Math.abs(lm[5].x - lm[17].x);
  if(I && M && R && P && spread > 0.12) return 'Stop ‚úã';
  return null;
}

function detectTwoHands(results){
  if(!results.multiHandLandmarks || results.multiHandLandmarks.length < 2) return null;
  const A = results.multiHandLandmarks[0], B = results.multiHandLandmarks[1];
  const aCenter = { x:(A[0].x + A[9].x)/2, y:(A[0].y + A[9].y)/2 };
  const bCenter = { x:(B[0].x + B[9].x)/2, y:(B[0].y + B[9].y)/2 };
  const d = dist(aCenter, bCenter);
  if(d < 0.11) return 'Clap üôå';
  if(d < 0.18 && Math.abs(A[9].y - B[9].y) < 0.06 && A[9].y < 0.6) return 'High Five ‚úãü§ö';
  if(A[4] && B[4] && A[8] && B[8] && dist(A[4],B[4]) < 0.12 && dist(A[8],B[8]) < 0.12) return 'Heart ü´∂';
  if(dist(A[9], B[9]) < 0.06 && Math.abs(A[9].y - B[9].y) < 0.05) return 'Pray üôè';
  if(dist(A[0], B[0]) < 0.06) return 'Cross Arms ‚ùå';
  if(A[8] && B[8] && A[4] && B[4] && (Math.abs(A[8].x - B[8].x) > 0.15) && (Math.abs(A[4].x - B[4].x) > 0.15)) return 'Frame ‚¨õ';
  if(d < 0.1 && Math.abs(A[0].y - B[0].y) < 0.12) return 'Handshake ü§ù';
  const zoom = detectZoomTrend(d);
  if(zoom) return zoom;
  return null;
}

// smoothing + publish (NOTE: does NOT write to chat)
function pushHistory(lbl){
  detHistory.push(lbl);
  if(detHistory.length > DET_HISTORY_LEN) detHistory.shift();
  const counts = {}; let best = detHistory[detHistory.length-1];
  detHistory.forEach(x => counts[x] = (counts[x]||0) + 1);
  let bestC = 0;
  for(const k in counts) if(counts[k] > bestC){ best = k; bestC = counts[k]; }
  return best;
}
function publishGesture(label){
  translationEl.textContent = label;
  translationMeta.textContent = `${LOCAL ? LOCAL.name : 'Host'} ‚Ä¢ ${now()}`;
  // small automatic reaction visuals for some gestures (doesn't write to chat)
  if(label.includes('Thumbs Up')) spawnReactionOnElement(hostCard, 'üëç', LOCAL?LOCAL.name:'Host');
  if(label.includes('Clap')) spawnReactionOnElement(hostCard, 'üëè', LOCAL?LOCAL.name:'Host');
  if(label.includes('Heart')) spawnReactionOnElement(hostCard, 'ü´∂', LOCAL?LOCAL.name:'Host');
}

// MediaPipe onResults
function onResults(results){
  gctx.clearRect(0,0,gestureCanvas.width,gestureCanvas.height);
  if(results.multiHandLandmarks){
    for(let i=0;i<results.multiHandLandmarks.length;i++){
      drawConnectors(gctx, results.multiHandLandmarks[i], HAND_CONNECTIONS, { color:'#00ffa8', lineWidth:2 });
      drawLandmarks(gctx, results.multiHandLandmarks[i], { color:'#00d1ff', lineWidth:1 });
    }
  }
  let label = null;
  if(results.multiHandLandmarks && results.multiHandLandmarks.length >= 2){
    label = detectTwoHands(results);
  }
  if(!label && results.multiHandLandmarks && results.multiHandLandmarks.length >= 1){
    const lm = results.multiHandLandmarks[0];
    const handed = results.multiHandedness && results.multiHandedness[0] && results.multiHandedness[0].label ? results.multiHandedness[0].label : 'Right';
    label = detectSingleHand(lm, handed);
  }
  if(!label) label = 'Waiting for gesture...';
  const stable = pushHistory(label);
  const nowTs = Date.now();
  if(stable !== 'Waiting for gesture...' && (lastPublished.text !== stable || (nowTs - lastPublished.ts) > PUBLISH_COOLDOWN)){
    lastPublished = { text: stable, ts: nowTs };
    publishGesture(stable);
  } else {
    if(stable === 'Waiting for gesture...'){ translationEl.textContent = 'Waiting for gesture...'; translationMeta.textContent = '‚Äî'; }
    else translationEl.textContent = stable;
  }
}

// init MediaPipe when host has localStream
function initMediaPipe(){
  if(!localStream) return;
  if(hands && cameraMp){ try{ cameraMp.stop(); }catch(e){} hands=null; cameraMp=null; }
  hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
  hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.6, minTrackingConfidence: 0.6 });
  hands.onResults(onResults);

  resizeCanvas();
  cameraMp = new Camera(hostVideo, { onFrame: async ()=> { await hands.send({ image: hostVideo }); }, width:1280, height:720 });
  cameraMp.start();
}

// ---------- Init UI ----------
(function start(){
  resizeCanvas();
  joinModalBackdrop.style.display = 'grid';
  renderAll();
})();

</script>
</body>
</html>